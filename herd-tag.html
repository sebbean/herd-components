<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-ajax/core-ajax.html">

<link rel="import" href="./herd-config.html">

<script src='../js-yaml/dist/js-yaml.min.js'></script>

<polymer-element name="herd-tag" attributes="aid asset options name">
  <template>
    <style>
    </style>
    <herd-config id='config'></herd-config>
    <core-ajax id='get-ajax'
      url='{{apiUrl}}/{{aid}}'
      handleAs='json'
      on-core-response={{handleGetResponse}}></core-ajax>

    <core-ajax id='ajax'
      url='{{apiUrl}}'
      method='POST'
      contentType='application/json'
      handleAs='json'
      on-core-response={{handleResponse}}></core-ajax>

    <template if='{{ child }}'>
      <template if='{{ isImage() }}'>
        <img src={{child.url}} />
      </template>

      <template if='{{ isVideo() }}'>
        <video width='{{ child.width }}' height='{{ child.height }}' autoplay loop muted>
          <source src='{{ child.url }}' type='{{ child.content_type }}'></source>
        </video>
      </template>
    </template>

    <content id='transforms' select='herd-transform'></content>
  </template>
  <script>
  // body='{{requestPayload()}}'
  Polymer({
    options: '',
    name: '',
    aid: null,
    asset: null,
    child: null,
    apiUrl: '/herd/assets',
    isVideo: function() {
      return this.asset.type.match(/Video/) != null
    },
    isImage: function() {
      return this.asset.type.match(/Image/) != null
    },
    ready: function() {
      if (this.asset) {
        if (this.asset.child_assets && this.options.length) {
          var self = this
          var match = this.asset.child_assets.filter(function(item) {
            return item.transform.options == self.specficOptions()
          })
          if (match.length) {
            this.child = match.pop()
          }
        }
        if (!this.child) {
          this.$.ajax.body = this.requestPayload()
          this.$.ajax.headers = this.$.config.requestHeaders
          this.$.ajax.go()
        }
      }
      else {
        this.$['get-ajax'].go()
      }
    },
    specficOptions: function() {
      return this.specificOptionsForType(this.child ? this.child.type : this.asset.type)
    },
    specificOptionsForType: function(type) {
      var found = this.$.config.transformForType(type)

      if (found) {
        return found.options
      } else
        return ''
    },
    effectiveName: function() {
      var found = this.$.config.transformForType(this.asset.type)

      return found && found.name ? found.name : this.name
    },
    combinedOptions: function() {
      var all =  jsyaml.load(this.options.split('|').join("\n"))
      // use asset or child?
      var scoped = jsyaml.load(this.specificOptionsForType(this.asset.type).split('|').join('\n'))
      debugger
      return all.concat(scoped).join('|')
    },
    requestPayload: function() {
      return JSON.stringify({
        asset: {
          parent_asset_id: this.asset.id,
          transform: {
            options: this.combinedOptions(),
            name: this.effectiveName()
          }
        }
      })
    },
    handleResponse: function(event, resp) {
      this.child = resp.response.asset
    },
    handleGetResponse: function(event, resp) {
      console.log(resp)
      debugger
    }
  })
  </script>
</polymer-element>
